<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FAMILIA OLAYA ‚Äì Regalo Secreto</title>
<style>
  :root{--bg1:#071027;--bg2:#0b3b2a;--text:#fff;--muted:rgba(255,255,255,.75);--card:rgba(255,255,255,.10);--shadow:0 22px 55px rgba(0,0,0,.45)}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
    background:radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.10), transparent 55%),
               radial-gradient(900px 700px at 80% 40%, rgba(255,255,255,.08), transparent 60%),
               linear-gradient(160deg,var(--bg1),var(--bg2));}
  .wrap{max-width:980px;margin:auto;padding:18px}
  header{background:linear-gradient(135deg, rgba(255,255,255,.15), rgba(255,255,255,.05));border-radius:22px;padding:14px;box-shadow:var(--shadow);display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:16px;display:grid;place-items:center;background:rgba(255,255,255,.15);font-size:26px}
  header h1{margin:0;font-size:18px;letter-spacing:1px}
  header p{margin:0;font-size:13px;color:var(--muted)}
  .grid{margin-top:14px;display:grid;grid-template-columns:1.15fr .85fr;gap:14px}
  @media(max-width:860px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,var(--card),rgba(255,255,255,.05));border-radius:22px;box-shadow:var(--shadow);padding:16px;position:relative;min-height:520px;overflow:hidden}
  .help{font-size:13px;color:var(--muted);margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
  input{flex:1 1 240px;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.25);color:#fff;font-size:14px;outline:none}
  button{padding:12px 16px;border-radius:14px;border:0;cursor:pointer;font-weight:900;background:linear-gradient(135deg,#6bffb3,#b6ffea);user-select:none}
  button:disabled{opacity:.6;cursor:not-allowed}
  .bigResult{margin-top:12px;border-radius:18px;padding:14px;background:linear-gradient(135deg, rgba(107,255,179,.18), rgba(255,255,255,.06));min-height:120px;position:relative;overflow:hidden}
  .bigResult h3{margin:0;font-size:13px;letter-spacing:1px;color:rgba(255,255,255,.9)}
  .resultLine{margin-top:6px;font-size:clamp(20px,5vw,34px);font-weight:950;text-shadow:0 14px 30px rgba(0,0,0,.45);line-height:1.1}
  .receiver{display:inline-block;padding:6px 12px;border-radius:14px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.18);position:relative;animation:bombZoom 1s ease-out forwards}
  .receiver::after{content:"üí•";position:absolute;top:-22px;right:-22px;font-size:24px}
  @keyframes bombZoom{0%{transform:scale(1)}40%{transform:scale(1.35)}100%{transform:scale(1.2)}}
  .participants{position:absolute;bottom:12px;left:12px;right:12px;background:rgba(0,0,0,.25);border-radius:16px;padding:10px;border:1px solid rgba(255,255,255,.14)}
  .participants h4{margin:0 0 6px;font-size:12px;text-transform:uppercase;color:rgba(255,255,255,.85);letter-spacing:.5px}
  .list{display:flex;flex-wrap:wrap;gap:6px;max-height:110px;overflow:auto;padding-right:6px}
  .chip{padding:5px 9px;font-size:12px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.14);cursor:pointer;user-select:none;white-space:nowrap}
  .wheelWrap{text-align:center}
  .pointer{width:0;height:0;margin:0 auto 10px;border-left:14px solid transparent;border-right:14px solid transparent;border-top:22px solid #fff;filter:drop-shadow(0 10px 12px rgba(0,0,0,.35))}
  canvas{width:100%;max-width:420px;border-radius:50%;box-shadow:0 18px 45px rgba(0,0,0,.4);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14)}
</style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="logo">üéÅ</div>
    <div>
      <h1>FAMILIA OLAYA</h1>
      <p>Regalo Secreto 2025 ‚Äì cada persona juega 1 vez</p>
    </div>
  </header>

  <div class="grid">
    <section class="card">
      <h2>üë§ Participante</h2>
      <p class="help">Escribe tu nombre EXACTO (o t√≥calo en la lista). Si ya jugaste, te muestra tu resultado guardado.</p>

      <div class="row">
        <input id="name" placeholder="Tu nombre (ej: Sebas)"/>
        <button id="spinBtn">üé° GIRAR RULETA</button>
      </div>

      <div class="bigResult">
        <h3>RESULTADO</h3>
        <div class="resultLine" id="resultText">A√∫n no has girado</div>
      </div>

      <div class="participants">
        <h4>üìú PARTICIPANTES</h4>
        <div class="list" id="plist"></div>
      </div>
    </section>

    <section class="card wheelWrap">
      <h2>üéÑ Ruleta</h2>
      <div class="pointer"></div>
      <canvas id="wheel" width="520" height="520"></canvas>
    </section>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  try {
    // ‚úÖ USAR googleusercontent (evita Failed to fetch / CORS)
    const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiViYQa2NOP0iqlClLZKn6pDc6VJ3drqWY_CyueLbxh5g8Eu8QEfUHPH6b6TGEim0TdZX64e501dECIkCb6-K1z5oTZkL3TIJ4GYjWEsDgwRdQDFaXCm0vWrPScZEfwfjI4QOzbT2hlNJAgfcpB9RatOkTXSEqlUpXbRkhpvaPjtd9fTRjVkV1DbIk1RLISoiT4Wzi2_xDi6Hbwr2BZIJ91OAiFlpA4C1nGajy9sjZuUhnStIpxl6V5MHWKI07bkXOnPFuBBCb5Lc9uPdtktclJBAZF2RsweaQm6GoysV0hVYRoQOYBKDmp96AfO2pty08Wax8e&lib=MLWmX6e-8fZVMGdtlYipV63w30xOjTIVN";

    const FAMILY = ["MariaC","Nathalia","Sebas","CarlosH","PAPA","Paola","Valeria","Juancho","Jaime","Luna","Mama Luna"];

    const nameInput = document.getElementById("name");
    const spinBtn   = document.getElementById("spinBtn");
    const resultEl  = document.getElementById("resultText");
    const plist     = document.getElementById("plist");
    const canvas    = document.getElementById("wheel");

    function normalize(s){
      return (s||"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    }

    // chips
    plist.innerHTML = "";
    FAMILY.forEach(n=>{
      const c=document.createElement("div");
      c.className="chip";
      c.textContent=n;
      c.onclick=()=>{ nameInput.value=n; nameInput.focus(); };
      plist.appendChild(c);
    });

    // wheel
    const ctx = canvas.getContext("2d");
    let rot=0, spinning=false, highlight=-1;

    function drawWheel(rotation, hiIdx=-1){
      const r = canvas.width/2;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.save();
      ctx.translate(r,r);
      ctx.rotate(rotation);

      const ang = 2*Math.PI / FAMILY.length;

      for(let i=0;i<FAMILY.length;i++){
        const start=i*ang, end=(i+1)*ang;
        const isHi=i===hiIdx;
        const radius=isHi ? r*0.93 : r*0.90;
        const hue=i*360/FAMILY.length;

        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius,start,end);
        ctx.closePath();
        ctx.fillStyle=`hsl(${hue},80%,${isHi?"62%":"55%"})`;
        ctx.fill();

        ctx.lineWidth=isHi?6:2;
        ctx.strokeStyle=isHi?"rgba(255,255,255,.95)":"rgba(255,255,255,.22)";
        ctx.stroke();

        ctx.save();
        ctx.rotate(start + ang/2);
        ctx.fillStyle="#fff";
        ctx.font=isHi?"900 18px system-ui":"bold 16px system-ui";
        ctx.textAlign="right";
        ctx.fillText(FAMILY[i], radius*0.92, 6);
        ctx.restore();
      }

      ctx.restore();
    }
    drawWheel(rot);

    function easeOutQuint(t){ return 1 - Math.pow(1-t,5); }

    // ‚úÖ GET/POST sin bloqueo (nota: API_URL ya tiene '?', por eso usamos '&')
    async function getOrCreateAssignment(giver){
      const q = `${API_URL}&action=get&giver=${encodeURIComponent(giver)}`;
      const r1 = await fetch(q, { redirect:"follow", cache:"no-store" });
      const j1 = await r1.json();
      if(j1.ok && j1.assignment) return j1.assignment;

      const r2 = await fetch(API_URL, {
        method:"POST",
        redirect:"follow",
        cache:"no-store",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({ giver })
      });
      const j2 = await r2.json();
      if(!j2.ok) throw new Error(j2.error || "Error API");
      return j2.assignment;
    }

    spinBtn.onclick = async ()=>{
      if(spinning) return;

      const giver=(nameInput.value||"").trim();
      const giverN=normalize(giver);

      if(!FAMILY.map(normalize).includes(giverN)){
        alert("Nombre no v√°lido. Usa uno de la lista.");
        return;
      }

      try{
        spinBtn.disabled=true;
        spinning=true;
        highlight=-1;
        resultEl.textContent="Consultando servidor...";

        const assignment = await getOrCreateAssignment(giver);
        const receiver = assignment.receiver;

        const idx = FAMILY.findIndex(n => normalize(n)===normalize(receiver));
        if(idx < 0) throw new Error("El receptor devuelto por el servidor no est√° en la lista local.");

        const ang=2*Math.PI/FAMILY.length;
        const targetCenter=(idx+0.5)*ang;

        const start=rot;
        const end=rot + 10*(2*Math.PI) + (Math.PI*1.5 - targetCenter);
        const dur=5200;
        const t0=performance.now();

        const anim=(now)=>{
          const p=Math.min(1,(now-t0)/dur);
          rot=start+(end-start)*easeOutQuint(p);
          drawWheel(rot,-1);
          if(p<1) requestAnimationFrame(anim);
          else{
            highlight=idx;
            drawWheel(rot,highlight);
            resultEl.innerHTML = `<b>${giver.toUpperCase()}</b> debe dar regalo a <span class="receiver">${receiver.toUpperCase()}</span>`;
            spinning=false;
            spinBtn.disabled=false;
          }
        };
        requestAnimationFrame(anim);

      }catch(err){
        spinning=false;
        spinBtn.disabled=false;
        resultEl.textContent="ERROR: " + err.message;
      }
    };

  } catch (e) {
    const r = document.getElementById("resultText");
    if(r) r.textContent = "ERROR inicializando: " + e.message;
    alert("ERROR inicializando: " + e.message);
  }
});
</script>
</body>
</html>

